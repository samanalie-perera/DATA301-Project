---
title: "Assignment 3"
author: "Vivian, 300525329
Saumya Sajwan, 300529034
Samanalie Perera, 300486075"
date: "2022-08-30"
output: html_document
---
# Background and Data

## Datasets
NHANES (National Health and Nutrition Examination Survey) March 2005 - 2020 Mental Health - Depression Screener datasets.

## Source
https://wwwn.cdc.gov/nchs/nhanes/Search/DataPage.aspx?Component=Questionnaire

## Interest
We are interested in creating a machine learning model that finds and uses key features to identify individuals who are potentially suffering from depression. 

## Structure of the dataset
There are 17 variables in our dataset: 3 categorical variables and 14 numerical variables. Therefore, we will use 10 variables; each is a question the respondents need to answer to help us identify whether a person has depression.

## Complete dataset
- The dataset consists of data from 2005 to March of 2020. We were going to add in later data from 2004-1999, however the datasets for them were completely different. They had more questions and didn't match the 2005-2020 questions, so we decided to not add them in. 

- We also got rid of all the NA values. These values don't have any value to our target variable. This meant that our dataset went down from 43,928 to 26,627. 17, 301 values were taken out.  


## Steps to integrate the datasets
To create the data set, the Mental health - Depression Screener data sets was combined into one:

- Loaded the NHANES package on R, only the datasets from 2005 to 2014 were part of the package so for 2015 - March 2020, we had to read them in using a R function (foreign::read.xport) where it reads the data from a SAS XPORT file and returns the data in a dataframe. 
- Adding in more columns: filename, cycle, start year and end year, so the data from the newer datasets match the older ones.
- Added all the datasets together into one large dataset using rbind
- To find out the total score each individual had, we added each of the columns together and added them to a new column called Score
- Adding in another column for classifying whether or not a individual has depression. For that we said that if Score was 10 or higher then that person has depression if not they don't. We used this website for the score: https://bmcrheumatol.biomedcentral.com/articles/10.1186/s41927-021-00236-w#:~:text=Adults%20(%E2%89%A5%2018%20years)%20with,9%20(PHQ%2D9)

# Ethics, Privacy and Security 

## Ethical considerations
There are a number of ethical concerns that need to be considered when developing and deploying a machine learning algorithm that predicts if an individual is depressed. First, it is important to consider the potential impact of false positives and false negatives. If the algorithm incorrectly predicts that an individual is depressed, this could lead to them being unnecessarily treated or stigmatized. On the other hand, if the algorithm fails to predict that an individual is depressed, this could result in them not receiving the help they need. 

## Privacy concerns

## Security concerns
If the algorithm is made public via a data leak, then anyone could use it to find out which individuals are more likely to be depressed. This information could be used to target those individuals with ads or content that exploits their vulnerabilities. For example, an advertiser could show ads for antidepressant medications to someone who is predicted to be depressed. 

# Exploratory Data Analysis
## Loading Data
```{r}
library(RNHANES)
library(foreign)
```

# Loading the Data
## Depression Data
```{r}
# 2005 - 2014 datasets
data2005 <- nhanes_load_data("DPQ_D", "2005-2006")
data2007 <- nhanes_load_data("DPQ_E", "2007-2008")
data2009 <- nhanes_load_data("DPQ_F", "2009-2010")
data2011 <- nhanes_load_data("DPQ_G", "2011-2012")
data2013 <- nhanes_load_data("DPQ_H", "2013-2014")
```

```{r}
# 2015 - 2016 datasets

#https://static-bcrf.biochem.wisc.edu/courses/Tabular-data-analysis-with-R-and-Tidyverse/book/6-importingdata.html
download.file("https://wwwn.cdc.gov/nchs/nhanes/2015-2016/DPQ_I.xpt", 
              temp <- tempfile(), 
              mode="wb")

data2015 <- foreign::read.xport(temp)

#adding in columns that were missing from 2015 and 2017 data
data2015$file_name <- c("DPQ_I")
data2015$cycle <- c("2015-2016")
data2015$begin_year <- c(2015)
data2015$begin_year <- as.double(data2015$begin_year)

data2015$end_year <- c(2016)
data2015$end_year <- as.double(data2015$end_year)
```

```{r}
# March 2017 - 202020 datasets
download.file("https://wwwn.cdc.gov/nchs/nhanes/2017-2018/P_DPQ.xpt", 
              tf <- tempfile(), 
              mode="wb")

data2017 <- foreign::read.xport(tf)
data2017$file_name <- c("P_DPQ")
data2017$cycle <- c("2017-March 2020")
data2017$begin_year <- c(2017)
data2017$begin_year <- as.double(data2017$begin_year)
data2017$end_year <- c(2020)
data2017$end_year <- as.double(data2017$end_year)
```

```{r}
# Combining all the datasets from 2009 to 2018 into one
dataFrom20052008 <- rbind(data2005, data2007)
dataFrom20092011 <- rbind(data2009,data2011)
dataFrom20052011 <- rbind(dataFrom20052008,dataFrom20092011)
dataFrom20112014 <- rbind(dataFrom20052011, data2013)
dataFrom20152017 <- rbind(data2015, data2017)
fulldataset <- rbind(dataFrom20112014,dataFrom20152017 )
```

```{r}
# Omitting all NA values: 40,496 to 24,449. 16,047 values were taken out. 
fulldataset <- na.omit(fulldataset)
```

```{r}
#Website: https://bmcrheumatol.biomedcentral.com/articles/10.1186/s41927-021-00236-w#:~:text=Adults%20(%E2%89%A5%2018%20years)%20with,9%20(PHQ%2D9).

# Adding in a score column by calculating all the values in each column for a individual to get them a final score 
fulldataset$score <- fulldataset$DPQ010 + fulldataset$DPQ020 + fulldataset$DPQ030 + fulldataset$DPQ040 + fulldataset$DPQ050 + fulldataset$DPQ060 + fulldataset$DPQ060 + fulldataset$DPQ070 + fulldataset$DPQ080 + fulldataset$DPQ090 + fulldataset$DPQ100

#If a score is greater or equal to 10, "1" means the individual has depression. "0" means the individual doesn't have depression
fulldataset$finalScore <- ifelse(fulldataset$score <= 10, "0", "1")
head(fulldataset)
```

## Demographics Data
```{r}
DEMdata2005 <- nhanes_load_data("DEMO_D", "2005-2006")
DEMdata2007 <- nhanes_load_data("DEMO_E", "2007-2008")
DEMdata2009 <- nhanes_load_data("DEMO_F", "2009-2010")
DEMdata2011 <- nhanes_load_data("DEMO_G", "2011-2012")
DEMdata2013 <- nhanes_load_data("DEMO_H", "2013-2014")

download.file("https://wwwn.cdc.gov/nchs/nhanes/2015-2016/DEMO_I.xpt", 
              temp <- tempfile(), 
              mode="wb")

DEMdata2015 <- foreign::read.xport(temp)

################################################################################

download.file("https://wwwn.cdc.gov/nchs/nhanes/2017-2018/P_DEMO.xpt", 
              tf <- tempfile(), 
              mode="wb")

DEMdata2017 <- foreign::read.xport(tf)
```

```{r}
demo_col <- c('SEQN', 'RIDAGEYR', 'RIAGENDR', 'RIDRETH1', 'DMDMARTL', 'INDFMPIR')

reduce_DEMdata2005 <- DEMdata2005[,demo_col]
reduce_DEMdata2007 <- DEMdata2007[,demo_col]
reduce_DEMdata2009 <- DEMdata2009[,demo_col]
reduce_DEMdata2011 <- DEMdata2011[,demo_col]
reduce_DEMdata2013 <- DEMdata2013[,demo_col]
reduce_DEMdata2015 <- DEMdata2015[,demo_col]

demo2005_2015 <- do.call(rbind, list(reduce_DEMdata2005, reduce_DEMdata2007,
                            reduce_DEMdata2009, reduce_DEMdata2011,
                            reduce_DEMdata2013, reduce_DEMdata2015))

names(demo2005_2015) <- c('id', 'age','gender','race', 'marital_status', 'Family PIR')
```

```{r}
demo_col <- c('SEQN', 'RIDAGEYR', 'RIAGENDR', 'RIDRETH1', 'DMDMARTZ', 'INDFMPIR')
reduce_DEMdata2017 <- DEMdata2017[,demo_col]
names(reduce_DEMdata2017) <- c('id', 'age','gender','race', 'marital_status', 'Family PIR')

demo <- do.call(rbind, list(demo2005_2015, reduce_DEMdata2017))
demo <- demo[!(demo$marital_status == 77 | demo$marital_status == 99),]
demo <- na.omit(demo)
head(demo)
```

```{r}
summary(demo)
dim(demo)
```

## Sleep Disorders
```{r}
SLPdata2005 <- nhanes_load_data("SLQ_D", "2005-2006")
SLPdata2007 <- nhanes_load_data("SLQ_E", "2007-2008")
SLPdata2009 <- nhanes_load_data("SLQ_F", "2009-2010")
SLPdata2011 <- nhanes_load_data("SLQ_G", "2011-2012")
SLPdata2013 <- nhanes_load_data("SLQ_H", "2013-2014")

download.file("https://wwwn.cdc.gov/nchs/nhanes/2015-2016/SLQ_I.xpt", 
              temp <- tempfile(), 
              mode="wb")

SLPdata2015 <- foreign::read.xport(temp)

################################################################################

download.file("https://wwwn.cdc.gov/nchs/nhanes/2017-2018/P_SLQ.xpt", 
              tf <- tempfile(), 
              mode="wb")

SLPdata2017 <- foreign::read.xport(tf)
```

```{r}
sleep_col <- c('SEQN', 'SLD010H', 'SLQ050')

reduce_SLPdata2005 <- SLPdata2005[,sleep_col]
reduce_SLPdata2007 <- SLPdata2007[,sleep_col]
reduce_SLPdata2009 <- SLPdata2009[,sleep_col]
reduce_SLPdata2011 <- SLPdata2011[,sleep_col]
reduce_SLPdata2013 <- SLPdata2013[,sleep_col]

sleep2005_2013 <- do.call(rbind, list(reduce_SLPdata2005, reduce_SLPdata2007,
                             reduce_SLPdata2009, reduce_SLPdata2011,
                             reduce_SLPdata2013))

names(sleep2005_2013) <- c('id', 'sleep_hours', 'trouble_sleeping_history')

sleep2005_2013 <- sleep2005_2013[!(sleep2005_2013$sleep_hours == 77 | sleep2005_2013$sleep_hours == 99),]
```

```{r}
sleep_col <- c('SEQN', 'SLD012', 'SLQ050')
reduce_SLPdata2015 <- SLPdata2015[,sleep_col]
names(reduce_SLPdata2015) <- c('id', 'sleep_hours', 'trouble_sleeping_history')

reduce_SLPdata2017 <- SLPdata2017[,sleep_col]
names(reduce_SLPdata2017) <- c('id', 'sleep_hours', 'trouble_sleeping_history')


sleep <- do.call(rbind, list(sleep2005_2013, reduce_SLPdata2015,
                             reduce_SLPdata2017))

sleep <- na.omit(sleep)

head(sleep)
```

```{r}
summary(sleep)
dim(sleep)
```

## Alcohol Use
```{r}
ALCdata2005 <- nhanes_load_data("ALQ_D", "2005-2006")
ALCdata2007 <- nhanes_load_data("ALQ_E", "2007-2008")
ALCdata2009 <- nhanes_load_data("ALQ_F", "2009-2010")
ALCdata2011 <- nhanes_load_data("ALQ_G", "2011-2012")
ALCdata2013 <- nhanes_load_data("ALQ_H", "2013-2014")

download.file("https://wwwn.cdc.gov/nchs/nhanes/2015-2016/ALQ_I.xpt", 
              temp <- tempfile(), 
              mode="wb")

ALCdata2015 <- foreign::read.xport(temp)

################################################################################

download.file("https://wwwn.cdc.gov/nchs/nhanes/2017-2018/P_ALQ.xpt", 
              tf <- tempfile(), 
              mode="wb")

ALCdata2017 <- foreign::read.xport(tf)
```

```{r}
alcohol_col <- c('SEQN', 'ALQ130')

reduce_ALCdata2005 <- ALCdata2005[,alcohol_col]
reduce_ALCdata2007 <- ALCdata2007[,alcohol_col]
reduce_ALCdata2009 <- ALCdata2009[,alcohol_col]
reduce_ALCdata2011 <- ALCdata2011[,alcohol_col]
reduce_ALCdata2013 <- ALCdata2013[,alcohol_col]
reduce_ALCdata2015 <- ALCdata2015[,alcohol_col]
reduce_ALCdata2017 <- ALCdata2017[,alcohol_col]

alcohol <- do.call(rbind, list(reduce_ALCdata2005, reduce_ALCdata2007,
                             reduce_ALCdata2009, reduce_ALCdata2011,
                             reduce_ALCdata2013, reduce_ALCdata2015,
                             reduce_ALCdata2017))

names(alcohol) <- c('id', 'drinks_per_occasion')

alcohol <- alcohol[!(alcohol$drinks_per_occasion == 777 | alcohol$drinks_per_occasion == 999),]

alcohol <- na.omit(alcohol)

head(alcohol)
```

```{r}
summary(alcohol)
dim(alcohol)
```

## Smoking
```{r}
SMKdata2005 <- nhanes_load_data("SMQ_D", "2005-2006")
SMKdata2007 <- nhanes_load_data("SMQ_E", "2007-2008")
SMKdata2009 <- nhanes_load_data("SMQ_F", "2009-2010")
SMKdata2011 <- nhanes_load_data("SMQ_G", "2011-2012")
SMKdata2013 <- nhanes_load_data("SMQ_H", "2013-2014")

download.file("https://wwwn.cdc.gov/nchs/nhanes/2015-2016/SMQ_I.xpt", 
              temp <- tempfile(), 
              mode="wb")

SMKdata2015 <- foreign::read.xport(temp)

################################################################################

download.file("https://wwwn.cdc.gov/nchs/nhanes/2017-2018/P_SMQ.xpt", 
              tf <- tempfile(), 
              mode="wb")

SMKdata2017 <- foreign::read.xport(tf)
```

```{r}
smoking_col <- c('SEQN', 'SMQ020')

reduce_SMKdata2005 <- SMKdata2005[,smoking_col]
reduce_SMKdata2007 <- SMKdata2007[,smoking_col]
reduce_SMKdata2009 <- SMKdata2009[,smoking_col]
reduce_SMKdata2011 <- SMKdata2011[,smoking_col]
reduce_SMKdata2013 <- SMKdata2013[,smoking_col]
reduce_SMKdata2015 <- SMKdata2015[,smoking_col]
reduce_SMKdata2017 <- SMKdata2017[,smoking_col]

smoking <- do.call(rbind, list(reduce_SMKdata2005, reduce_SMKdata2007,
                             reduce_SMKdata2009, reduce_SMKdata2011,
                             reduce_SMKdata2013, reduce_SMKdata2015,
                             reduce_SMKdata2017))

names(smoking) <- c('id', 'smoked_at_least_100')

smoking <- smoking[!(smoking$smoked_at_least_100 == 7 | smoking$smoked_at_least_100 == 9),]

smoking <- na.omit(smoking)

head(smoking)
```

```{r}
summary(smoking)
dim(smoking)
```

# Complete dataset
```{r}
df_list <- list(demo, sleep, alcohol, smoking)      
var_df <- Reduce(function(x, y) merge(x, y, all=TRUE), df_list)  
var_df <- na.omit(var_df)
head(var_df)
```

```{r}
depression <- data.frame(fulldataset$SEQN, fulldataset$finalScore)
names(depression) <- c('id', 'result')
df <- merge(depression, var_df, by = c("id"))       
head(df)
```

```{r}
dim(df)
summary(df)
```



# Individual Contributions
## Vivian, 300525329

## Saumya Sajwan, 300529034

## Samanalie Perera, 300486075


